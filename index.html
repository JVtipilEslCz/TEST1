<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evidenční systém půjčovny</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style> 
body { font-family: Calibri, sans-serif; display: flex; justify-content: center; }
h1 { text-align: center; }
@keyframes fadeOutHighlight { 0% { background-color: #89CFF0; } 100% { background-color: white; } }
.highlight { animation: fadeOutHighlight 5s forwards; }
.container { max-width: 500px; width: 100%; padding: 20px; box-sizing: border-box; }
.device-container { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
.device-header { display: flex; justify-content: space-between; font-weight: bold; width: 100%; }
.device-status.available { color: green; }
.device-status.loaned { color: red; }
button { width: 120px; padding: 10px; margin: 5px; border: none; cursor: pointer; border-radius: 5px; }
button.loan { background-color: #28a745; color: white; }
button.return { background-color: #dc3545; color: white; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1); border-radius: 5px; }
</style>
</head>

<body>
<div class="container">
<h1>Evidenční systém půjčovny</h1>
<div class="scan-buttons-container">
<button onclick="startScanner()">Spustit skener</button>
<button onclick="stopScanner()">Zastavit skener</button>
</div>
<video id="video" width="300" height="300" autoplay></video>
<p id="scannerStatus"></p>
<h2>Seznam zařízení</h2>
<button onclick="showAddDeviceDialog()">+</button>
<button onclick="showDeleteDeviceDialog()">-</button>
<button onclick="exportDevices()">E</button>
<ul id="deviceList"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
import { getDatabase, ref, set, update, get, remove } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "XXX",
    authDomain: "XXX.firebaseapp.com",
    databaseURL: "XXX.firebaseio.com",
    projectId: "XXX",
    storageBucket: "XXX.appspot.com",
    messagingSenderId: "XXX",
    appId: "XXX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function getDeviceRef(id) {
    return ref(db, 'devices/' + id);
}

function showCustomDialog(message, callback) {
    const modal = document.createElement("div");
    modal.classList.add("modal");
    modal.innerHTML = `
        <p>${message}</p>
        <input type="text" id="modalInput">
        <button id="modalConfirm">OK</button>
        <button id="modalCancel">Zrušit</button>
    `;
    document.body.appendChild(modal);

    document.getElementById("modalConfirm").onclick = () => {
        callback(document.getElementById("modalInput").value);
        document.body.removeChild(modal);
    };
    document.getElementById("modalCancel").onclick = () => {
        document.body.removeChild(modal);
    };
}

window.showAddDeviceDialog = function() {
    showCustomDialog("Zadejte název zařízení:", (deviceName) => {
        if (deviceName) {
            const newDeviceRef = ref(db, 'devices/' + Date.now());
            set(newDeviceRef, { name: deviceName, status: "Dostupné" }).then(renderDevices);
        }
    });
};

window.showDeleteDeviceDialog = function() {
    showCustomDialog("Zadejte ID zařízení k odstranění:", (deviceId) => {
        if (deviceId) {
            remove(getDeviceRef(deviceId)).then(renderDevices);
        }
    });
};

function renderDevices() {
    const list = document.getElementById("deviceList");
    list.innerHTML = "";
    get(ref(db, 'devices/')).then((snapshot) => {
        if (snapshot.exists()) {
            Object.entries(snapshot.val()).forEach(([id, device]) => {
                let li = document.createElement("li");
                li.innerHTML = `
                    <div class="device-container">
                        <div class="device-header">
                            <span>${device.name}</span>
                            <span class="device-status ${device.status === "Dostupné" ? "available" : "loaned"}">${device.status}</span>
                        </div>
                        <button class="loan" onclick="loanDevice('${id}')">Půjčit</button>
                        <button class="return" onclick="returnDevice('${id}')">Vrátit</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }
    });
}

window.exportDevices = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    get(ref(db, 'devices/')).then((snapshot) => {
        if (!snapshot.exists()) return alert("Žádná zařízení k exportu.");

        Promise.all(Object.keys(snapshot.val()).map(generateQRCode)).then(qrDataArray => {
            let x = 10, y = 10;
            qrDataArray.forEach(({ key, imgData }) => {
                doc.text(`ID: ${key}`, x, y);
                doc.addImage(imgData, "PNG", x, y + 5, 50, 50);
                x += 60;
                if (x > 180) { x = 10; y += 70; }
            });
            doc.save("QR_kody.pdf");
        });
    });
};

function generateQRCode(key) {
    return new Promise(resolve => {
        const tempDiv = document.createElement("div");
        document.body.appendChild(tempDiv);
        new QRCode(tempDiv, { text: key, width: 128, height: 128 });
        setTimeout(() => {
            const img = tempDiv.querySelector("img");
            resolve({ key, imgData: img.src });
            document.body.removeChild(tempDiv);
        }, 300);
    });
}

let scanning = false, videoStream = null;
window.startScanner = function() {
    if (scanning) return;
    scanning = true;
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
        videoStream = stream;
        document.getElementById("video").srcObject = stream;
        document.getElementById("scannerStatus").innerText = "Skenování...";
    }).catch(() => stopScanner("Nepodařilo se spustit kameru."));
};

window.stopScanner = function(message = "Skener zastaven.") {
    scanning = false;
    if (videoStream) videoStream.getTracks().forEach(track => track.stop());
    document.getElementById("scannerStatus").innerText = message;
};

window.onload = renderDevices;
</script>
</body>
</html>
